import{LatLng as e,DomUtil as t,DomEvent as s,icon as o,Control as n}from"leaflet";import r from"react";import{render as i}from"react-dom";import{MapControl as a,Popup as l,Marker as c,withLeaflet as h}from"react-leaflet";import p from"prop-types";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function u(e,t,s,o){return new(s||(s=Promise))((function(n,r){function i(e){try{l(o.next(e))}catch(e){r(e)}}function a(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){e.done?n(e.value):new s((function(t){t(e.value)})).then(i,a)}l((o=o.apply(e,t||[])).next())}))}var d={OpenStreetMap:class{constructor(e){let t="",s="";if(e&&e.searchBounds&&e.searchBounds.length){t=`&bounded=1&viewbox=${e.searchBounds.reduce((e,t)=>[...e,t.lng,t.lat],[]).join(",")}`}e&&"region"in e&&(s=`&countrycodes=${e.region}`),this.url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&polygon_svg=1&namedetails=1${t}${s}&q=`}search(e){return u(this,void 0,void 0,(function*(){const t=yield fetch(this.url+e),s=yield t.json();return this.formatResponse(s)}))}formatResponse(e){const t=e;return{info:e.length>0?t.map(e=>({bounds:e.boundingbox.map(e=>Number(e)),latitude:Number(e.lat),longitude:Number(e.lon),name:e.display_name})):"Not Found",raw:e}}},BingMap:class{constructor(e){var t,s,o;this.key=null===(t=e)||void 0===t?void 0:t.providerKey;let n="";if(null===(o=null===(s=e)||void 0===s?void 0:s.searchBounds)||void 0===o?void 0:o.length){n=`&umv=${e.searchBounds.reduce((e,t)=>[...e,t.lat,t.lng],[]).join(",")}`}this.url=`https://dev.virtualearth.net/REST/v1/Locations?output=json${n}&key=${this.key}&q=`}search(e){return u(this,void 0,void 0,(function*(){if(void 0===this.key)return{error:"BingMap requires an api key"};const t=yield fetch(this.url+e).then(e=>e.json());return this.formatResponse(t)}))}formatResponse(e){const t=e.resourceSets[0].resources;return{info:e.resourceSets[0].estimatedTotal>0?t.map(e=>({bounds:e.bbox.map(e=>Number(e)),latitude:Number(e.point.coordinates[0]),longitude:Number(e.point.coordinates[1]),name:e.name})):"Not Found",raw:e}}}};const m=r.forwardRef(({placeholder:e="PlaceHolder",type:t="text",initialValue:s="",className:o="",debounceTime:n=400,getInputValueSetter:i=(()=>{}),onClick:a=(()=>{}),onDoubleClick:l=(()=>{}),onMouseDown:c=(()=>{}),onMouseEnter:h=(()=>{}),onMouseLeave:p=(()=>{}),onChange:u=(()=>{}),onChangeAsync:d=(()=>{}),onFocus:m=(()=>{}),onBlur:f=(()=>{}),onKeyUp:v=(()=>{}),onKeyDown:y=(()=>{}),onKeyPress:b=(()=>{}),onSubmit:g=(()=>{}),tabIndex:k=0},S)=>{const[w,I]=r.useState(s),C=r.useCallback((e,t)=>{t(e)},[]),N=r.useCallback(function(e,t,s=400){let o;return n=>{n.persist(),t&&t(n),clearTimeout(o),o=window.setTimeout(()=>{e(n)},s)}}(e=>{e.preventDefault(),e.stopPropagation(),d(e)},e=>{e.preventDefault(),e.stopPropagation(),I(e.target.value),u(e)},n),[I]);return r.useLayoutEffect(()=>{i(I)}),r.createElement("input",{tabIndex:k,ref:S,type:t,name:"SearchInput",value:w,placeholder:e,className:`search-input${o?` ${o}`:""}`,onClick:e=>C(e,a),onDoubleClick:e=>C(e,l),onMouseEnter:e=>C(e,h),onMouseLeave:e=>C(e,p),onMouseDown:e=>C(e,c),onChange:N,onFocus:e=>C(e,m),onBlur:e=>C(e,f),onKeyUp:e=>C(e,v),onKeyDown:e=>C(e,y),onKeyPress:e=>C(e,b),onSubmit:e=>C(e,g)})});function f({className:e="",onClick:t=(e=>{e.preventDefault(),e.stopPropagation()})}){return r.createElement("button",{className:`search-control-close-button${e?` ${e}`:""}`,onClick:t},r.createElement("svg",{viewBox:"0 0 50 50"},r.createElement("path",{d:"M5 5 L45 45 M45 5 L5 45"}),"Sorry, your browser does not support inline SVG."))}function v({className:e="",onClick:t=(()=>{}),onMouseEnter:s=(()=>{}),onMouseLeave:o=(()=>{})}){return r.createElement("button",{className:`${e||""}`,onClick:t,onMouseEnter:s,onMouseLeave:o},r.createElement("svg",{viewBox:"0 0 50 50"},r.createElement("line",{x1:"35",y1:"35",x2:"46",y2:"46"}),r.createElement("circle",{cx:"23",cy:"23",r:"16",fill:"none"}),"Sorry, your browser does not support inline SVG."))}const y=({value:e,className:t,candidate:s,onClick:o,onKeyDown:n,children:i})=>{const a=r.useRef(null);return r.useEffect(()=>{e===s&&a.current&&a.current.offsetParent&&a.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[s,e]),r.createElement("li",{ref:a,value:e,className:t,onClick:o,onKeyDown:n},i)},b=(e,t)=>{const{handler:s,list:o,tabIndex:n,activeIndex:i}=e,[a,l]=r.useState(0),c=r.useCallback(e=>{if(Array.isArray(o)){e.stopPropagation(),9!==e.keyCode&&e.preventDefault();const t=o.length;if((t<=a||a<0||13!==e.keyCode)&&32!==e.keyCode){const s=t<=a||a<0?0:a;38===e.keyCode?l(0===s?o.length-1:s-1):40===e.keyCode&&l(s+1===o.length?0:s+1)}else s(o[a],o,a)}},[l,a,o]);return r.useLayoutEffect(()=>l(0),[o]),Array.isArray(o)?r.createElement("ul",Object.assign({ref:t},void 0!==n?{tabIndex:e.tabIndex}:{},{className:"search-control-info-list",onKeyDown:c}),o.map((e,t)=>r.createElement(y,{value:t,candidate:a,key:`${e.name}-${t}`,className:`search-control-info-list-item${t===i||e.checked?" active":""}${a===t?" candidate":""}`,onClick:()=>{l(t),s(e,o,t)},onKeyDown:c},e.name))):r.createElement("span",{className:"search-control-info-span"},o)};b.displayName="SearchInfoList";const g=r.forwardRef(b);class k extends r.Component{constructor(t){if(super(t),this.setLock=e=>{this.lock=e},this.openSearch=()=>{this.setState({open:!0},()=>{var e;null===(e=this.input.current)||void 0===e||e.focus()})},this.closeSearch=()=>{this.setState({open:this.props.openSearchOnLoad,closeButton:!1,showInfo:!1},()=>{this.inputValueSetter(""),this.SearchResponseInfo="",this.props.removeMarker&&this.props.removeMarker({event:"remove"})})},this.aClick=e=>{e.preventDefault(),e.stopPropagation(),this.state.open?this.closeSearch():this.openSearch()},this.inputBlur=e=>{var t;""===(null===(t=this.input.current)||void 0===t?void 0:t.value)&&!this.lock&&this.closeSearch()},this.inputClick=e=>{var t,s,o;null===(t=this.input.current)||void 0===t||t.focus(),(null===(s=this.input.current)||void 0===s?void 0:s.value.startsWith(":"))||null===this.lastInfo||""===this.lastInfo||""===(null===(o=this.input.current)||void 0===o?void 0:o.value)||(this.SearchResponseInfo=this.lastInfo,this.lastInfo=null,this.setState({showInfo:!0}))},this.inputKeyUp=e=>{13===e.keyCode&&this.beautifyValue(this.input.current.value)},this.closeClick=e=>{this.closeSearch()},this.sendToAction=e=>u(this,void 0,void 0,(function*(){if(!this.input.current.value.startsWith(":"))if(Object.prototype.hasOwnProperty.call(this.responseCache,this.input.current.value))this.showInfo(this.responseCache[this.input.current.value].info);else if(this.input.current.value.length>=3){this.showInfo("Searching...");const e=yield this.provider.search(this.input.current.value);if(e.error)return!1;this.responseCache[this.input.current.value]=e,this.showInfo(e.info)}})),this.syncInput=()=>{var e,t;!this.state.closeButton&&this.setState({closeButton:!0}),""==(null===(e=this.input.current)||void 0===e?void 0:e.value)&&(this.hideInfo(),this.state.closeButton&&this.setState({closeButton:!1})),null===(t=this.input.current)||void 0===t||t.value.startsWith(":")},this.listItemClick=(t,s,o)=>{this.showInfo(s,o),this.props.handler&&this.props.handler({event:"add",payload:{latlng:new e(Number(t.latitude),Number(t.longitude)),info:t.name,raw:this.responseCache[this.input.current.value]}}),this.props.closeResultsOnClick&&this.hideInfo()},this.setMaxHeight=()=>{const e=this.props.map?this.props.map.getContainer().getBoundingClientRect():document.body.getBoundingClientRect(),t=this.input.current.getBoundingClientRect(),s=`${Math.floor(.6*(e.bottom-t.bottom-10))}px`;this.selectbox.current&&this.selectbox.current.style&&(this.selectbox.current.style.maxHeight=s)},this.state={open:this.props.openSearchOnLoad,closeButton:!1,showInfo:!1},this.SearchResponseInfo="",this.responseCache={},this.lastInfo=null,this.inputValueSetter=()=>{},this.selectbox=r.createRef(),this.div=r.createRef(),this.input=r.createRef(),this.props.customProvider)this.provider=this.props.customProvider;else{if(!this.props.provider||!Object.keys(d).includes(this.props.provider))throw new Error(`You set the provider prop to ${this.props.provider} but that isn't recognised. You can choose from ${Object.keys(d).join(", ")}`);{const e=d[this.props.provider];this.provider=new e(this.props.providerOptions)}}}beautifyValue(t){if(t.startsWith(":")){const s=t.slice(1).split(",").filter(e=>!isNaN(Number(e))).map(e=>Number(e||0));s.length<=1?this.showInfo("Please enter a valid lat, lng"):(this.hideInfo(),this.props.handler&&this.props.handler({event:"add",payload:{latlng:new e(Number(s[0]),Number(s[1])),info:s.join(","),raw:s.join(",")}}))}else if(this.input.current.value.length<3){const e='Please enter a valid lat,lng starting with ":" or minimum 3 character to search';this.showInfo(e)}}hideInfo(){this.lastInfo=this.SearchResponseInfo,this.SearchResponseInfo="",this.setState({showInfo:!1})}showInfo(e,t){var s;this.SearchResponseInfo=r.createElement(g,{ref:this.selectbox,activeIndex:t,list:e,handler:this.listItemClick,tabIndex:void 0!==this.props.tabIndex?this.props.tabIndex+1:2}),(null===(s=this.input.current)||void 0===s?void 0:s.value)&&this.setState({showInfo:!0})}componentDidMount(){if(this.setMaxHeight(),this.props.search&&!isNaN(Number(this.props.search.lat))&&!isNaN(Number(this.props.search.lng))){const t=`:${this.props.search.lat},${this.props.search.lng}`;this.inputValueSetter(t),this.openSearch(),this.syncInput(),this.props.handler&&this.props.handler({event:"add",payload:{latlng:new e(Number(this.props.search.lat),Number(this.props.search.lng)),info:t,raw:this.props.search}})}}componentDidUpdate(){this.setMaxHeight(),this.state.showInfo}render(){return r.createElement("article",{className:`${this.props.className?`${this.props.className} `:""}search-control-wrap`},r.createElement("section",{className:`search-control${this.state.open?" search-control-active":""}`},r.createElement(v,{className:"search-control-icon-button",onClick:this.aClick,onMouseEnter:()=>this.setLock(!0),onMouseLeave:()=>this.setLock(!1)}),r.createElement(m,{tabIndex:void 0!==this.props.tabIndex?this.props.tabIndex:1,ref:this.input,getInputValueSetter:e=>this.inputValueSetter=e,className:"search-control-input",placeholder:this.props.inputPlaceholder,onClick:this.inputClick,onMouseEnter:()=>this.setLock(!0),onMouseLeave:()=>this.setLock(!1),onChange:this.syncInput,onChangeAsync:this.sendToAction,onBlur:this.inputBlur,onKeyUp:this.inputKeyUp,onKeyPress:e=>{e.stopPropagation(),40===e.keyCode&&e.preventDefault()},onKeyDown:e=>{var t;40===e.keyCode&&(e.preventDefault(),e.stopPropagation(),null===(t=this.selectbox.current)||void 0===t||t.focus())},onSubmit:e=>e.preventDefault()}),r.createElement(f,{className:this.state.closeButton?" search-control-close-button-active":"",onClick:this.closeClick})),r.createElement("section",{className:`search-control-info-wrapper${this.state.showInfo?"":" search-control-info-wrapper-close"}`},r.createElement("section",{ref:this.div,className:"search-control-info"},this.state.showInfo&&this.SearchResponseInfo)))}}k.propTypes={provider:p.string,providerKey:p.string,inputPlaceholder:p.string,coords:p.arrayOf(p.number),closeResultsOnClick:p.bool,openSearchOnLoad:p.bool,searchBounds:p.array,providerOptions:p.object},k.defaultProps={inputPlaceholder:"Search Lat,Lng",closeResultsOnClick:!1,openSearchOnLoad:!1,search:void 0,provider:"OpenStreetMap"};class S extends a{constructor(e,n){var i;super(e),this.handler=({event:e,payload:t})=>{this.searchCallback&&this.searchCallback({event:e,payload:t}),"add"===e?t&&this.latLngHandler(t.latlng,t.info,t.raw):this.removeMarkerHandler()},this.div=t.create("div","leaflet-search-wrap"),s.disableClickPropagation(this.div),s.disableScrollPropagation(this.div),this.state={search:!1,info:!1},this.markerIcon=o({iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/images/marker-icon.png",iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/images/marker-icon-2x.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],tooltipAnchor:[16,-28],shadowSize:[41,41]}),this.SearchInfo=null,this.map=n.map||(null===(i=e.leaflet)||void 0===i?void 0:i.map),this.markerRef=r.createRef(),e.searchCallback&&(this.searchCallback=e.searchCallback)}createLeafletElement(e){return new(n.extend({onAdd:e=>this.div,onRemove:e=>{}}))(e)}latLngHandler(e,t,s){this.SearchInfo={info:t,latLng:e,raw:s};const o=r.createElement("div",null,r.createElement("p",null,Array.isArray(t)?t.toString():t),r.createElement("div",{className:"search-control-popup-seperator"}),r.createElement("div",null,`latitude: ${e.lat}`),r.createElement("div",null,`longitude: ${e.lng}`));this.goToLatLng(e,o)}removeMarkerHandler(){this.setState({search:!1})}goToLatLng(e,t){this.setState({search:e,info:t},()=>{this.flyTo()})}flyTo(){if(this.state.search)switch(this.props.mapStateModifier){case"flyTo":this.map&&this.map.flyTo(this.state.search,this.props.zoom,this.props.zoomPanOptions);break;case"setView":this.map&&this.map.setView(this.state.search,this.props.zoom,this.props.zoomPanOptions);break;default:"function"==typeof this.props.mapStateModifier&&this.props.mapStateModifier(this.state.search)}}componentDidMount(){super.componentDidMount&&super.componentDidMount(),i(r.createElement(k,Object.assign({className:this.props.className,provider:this.props.provider,customProvider:this.props.customProvider,providerOptions:this.props.providerOptions,openSearchOnLoad:this.props.openSearchOnLoad,closeResultsOnClick:this.props.closeResultsOnClick,inputPlaceholder:this.props.inputPlaceholder,search:this.props.search,map:this.map,handler:this.handler,removeMarker:this.handler},void 0!==this.props.tabIndex?{tabIndex:this.props.tabIndex}:{})),this.div)}componentDidUpdate(){this.markerRef.current&&this.markerRef.current.leafletElement.openPopup()}defaultPopUp(){return r.createElement(l,null,r.createElement("span",null,this.state.info))}render(){return this.SearchInfo&&this.state.search&&this.props.showMarker?r.createElement(c,{ref:this.markerRef,icon:this.props.markerIcon||this.markerIcon,key:`marker-search-${this.state.search.toString()}`,position:this.state.search},this.props.showPopup&&(this.props.popUp?this.props.popUp(this.SearchInfo):this.defaultPopUp())):null}}S.defaultProps={inputPlaceholder:"Search Lat,Lng",showMarker:!0,showPopup:!0,zoom:10,closeResultsOnClick:!1,openSearchOnLoad:!1,search:void 0,provider:"OpenStreetMap",mapStateModifier:"flyTo",zoomPanOptions:{animate:!0,duration:.25,easeLinearity:.25,noMoveStart:!1}};var w=h(S);export default w;export{d as Providers,S as ReactLeafletSearch,k as SearchControl};
